#include "runcall.hpp"
#include "classregistry.hpp"

#include <stdexcept>

using namespace boost;

bool CheckArgs(shared_ptr<tcp_connection> conn, MethodInfo mi, vector<TypedVal> args){
    
}

MethodInfo GetMethodInfo(shared_ptr<tcp_connection> conn, const string &cls, const string &method){
    ClassInfo clsi=conn->GetClassInfo(cls);
    for(size_t i=0; i<clsi.Methods.size(); ++i){
        if(clsi.Methods[i].MethodName==method) return clsi.Methods[i];
    }
    if(method=="ctor"){
        MethodInfo mi;
        mi.MethodName="ctor";
        mi.ReturnType=Types::Void;
        return mi;
    }
    throw std::exception(); //ERROR!
}

void RunConstruct(shared_ptr<tcp_connection> conn, const string &ns, const string &cls, CallID_t callid, vector<TypedVal> args){
    shared_ptr<tcp_connection> toconn=GetClassRegistry().GetConnection(ns);
    stringstream out;
    Serialize(out, Messages::Construct);
    Serialize(out, cls);
    CallID_t icallid=GetClassRegistry().NewCallID(conn, callid);
    Serialize(out, icallid);
    CheckArgs(conn, GetMethodInfo(toconn, cls, "ctor"), args);
    Serialize(out, args);
    toconn->send(out.str());
}

void RunCallStatic(shared_ptr<tcp_connection> conn, const string &ns, const string &cls, const string &method, CallID_t callid, vector<TypedVal> args){
    shared_ptr<tcp_connection> toconn=GetClassRegistry().GetConnection(ns);
    stringstream out;
    Serialize(out, Messages::StaticCall);
    Serialize(out, cls);
    Serialize(out, method);
    CallID_t icallid=GetClassRegistry().NewCallID(conn, callid);
    Serialize(out, icallid);
    Serialize(out, args);
    toconn->send(out.str());
}

void RunCallMethod(shared_ptr<tcp_connection> conn, ObjectID_t objectid, const string &method, CallID_t callid, vector<TypedVal> args){
    shared_ptr<tcp_connection> toconn=conn.GetOwner(objectid);
    stringstream out;
    Serialize(out, Messages::MethodCall);
    Serialize(out, conn.GetOwnerID(objectid));
    Serialize(out, method);
    CallID_t icallid=GetClassRegistry().NewCallID(conn, callid);
    Serialize(out, icallid);
    Serialize(out, args);
    toconn->send(out.str());
}
